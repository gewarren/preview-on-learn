(()=>{"use strict";const e=new class{constructor(){this.algorithm="AES-GCM",this.keyLength=256}async generateKey(){return await crypto.subtle.generateKey({name:this.algorithm,length:this.keyLength},!0,["encrypt","decrypt"])}async deriveKeyFromPassword(e){const t=new TextEncoder,n=t.encode(e),r=await crypto.subtle.importKey("raw",n,"PBKDF2",!1,["deriveBits","deriveKey"]);return await crypto.subtle.deriveKey({name:"PBKDF2",salt:t.encode("preview-on-learn-salt"),iterations:1e5,hash:"SHA-256"},r,{name:this.algorithm,length:this.keyLength},!1,["encrypt","decrypt"])}async getEncryptionKey(){const e=navigator.userAgent+"preview-on-learn-key-2025";return await this.deriveKeyFromPassword(e)}async encryptToken(e){try{const t=await this.getEncryptionKey(),n=(new TextEncoder).encode(e),r=crypto.getRandomValues(new Uint8Array(12)),o=await crypto.subtle.encrypt({name:this.algorithm,iv:r},t,n),s=new Uint8Array(r.length+o.byteLength);return s.set(r,0),s.set(new Uint8Array(o),r.length),btoa(String.fromCharCode(...s))}catch(e){throw console.error("Error encrypting token:",e),new Error("Failed to encrypt token")}}async decryptToken(e){try{const t=await this.getEncryptionKey(),n=new Uint8Array(atob(e).split("").map(e=>e.charCodeAt(0))),r=n.slice(0,12),o=n.slice(12),s=await crypto.subtle.decrypt({name:this.algorithm,iv:r},t,o);return(new TextDecoder).decode(s)}catch(e){throw console.error("Error decrypting token:",e),new Error("Failed to decrypt token")}}};class t{async hasGitHubToken(){return new Promise(e=>{chrome.runtime.sendMessage({type:"checkToken"},t=>{e(t?.hasToken||!1)})})}async getGitHubToken(){return new Promise(e=>{chrome.runtime.sendMessage({type:"getToken"},t=>{e(t?.token||null)})})}}class n{constructor(e){this.encryption=e}async hasGitHubToken(){try{const e=await chrome.storage.sync.get(["githubToken"]);if(!e.githubToken)return!1;try{return await this.encryption.decryptToken(e.githubToken),!0}catch(e){return console.warn("Found invalid encrypted token, clearing it:",e),await chrome.storage.sync.remove("githubToken"),!1}}catch(e){return console.error("Error checking for GitHub token:",e),!1}}async getGitHubToken(){try{const e=await chrome.storage.sync.get(["githubToken"]);if(!e.githubToken)return null;try{return await this.encryption.decryptToken(e.githubToken)}catch(e){return console.warn("Found invalid encrypted token, clearing it:",e),await chrome.storage.sync.remove("githubToken"),null}}catch(e){return console.error("Error getting GitHub token:",e),null}}}document.addEventListener("DOMContentLoaded",async function(){const r=document.getElementById("token-status"),o=document.getElementById("token-form"),s=document.getElementById("token-steps"),a=document.getElementById("github-token"),c=document.getElementById("save-token"),i=document.getElementById("clear-token"),y=document.getElementById("status"),l=function(e=null){return function(){try{return"undefined"!=typeof chrome&&void 0!==chrome.runtime&&"undefined"!=typeof window&&window.location&&window.location.protocol.startsWith("http")}catch(e){return!1}}()?new t:new n(e)}(e);try{await l.hasGitHubToken()?(r.style.display="flex",o.style.display="none",s.style.display="none",a.value=""):(r.style.display="none",o.style.display="block",s.style.display="block")}catch(e){console.error("Error loading token:",e),d("Error loading token: "+e.message,"error")}function d(e,t){y.textContent=e,y.className="status "+t,y.style.display="block",setTimeout(()=>{y.style.display="none"},4e3)}c.addEventListener("click",async function(){const t=a.value.trim();if(t)try{const n=await e.encryptToken(t);await chrome.storage.sync.set({githubToken:n}),d("Token saved successfully!","success"),r.style.display="flex",o.style.display="none",s.style.display="none",a.value=""}catch(e){d("Error saving token: "+e.message,"error")}else d("Please enter a valid token","error")}),i.addEventListener("click",async function(){try{await chrome.storage.sync.remove("githubToken"),r.style.display="none",o.style.display="block",s.style.display="block",a.value="",d("Token removed successfully!","success")}catch(e){d("Error removing token: "+e.message,"error")}})})})();